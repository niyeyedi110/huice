<!--pages/record/record.wxml-->
<view class="container">
  <!-- ç…§ç‰‡ä¸Šä¼ åŒºåŸŸ -->
  <view class="photo-section card">
    <view class="section-title">æ·»åŠ ç…§ç‰‡</view>
    <view class="photo-grid">
      <!-- å·²é€‰ç…§ç‰‡ -->
      <view wx:for="{{photos}}" wx:key="*this" class="photo-item">
        <image src="{{item}}" mode="aspectFill" bindtap="previewImage" data-index="{{index}}"></image>
        <view class="delete-btn" bindtap="deleteImage" data-index="{{index}}">
          <text class="delete-icon">âœ•</text>
        </view>
      </view>
      <!-- æ·»åŠ æŒ‰é’® -->
      <view wx:if="{{photos.length < maxPhotos}}" class="add-photo" bindtap="chooseImage">
        <text class="add-icon">â•</text>
        <text class="add-text">{{photos.length}}/{{maxPhotos}}</text>
      </view>
    </view>
  </view>

  <!-- è¥å…»åˆ†æ -->
  <view wx:if="{{photos.length > 0}}" class="nutrition-section card fade-in">
    <view class="section-header">
      <view class="section-title">
        <text class="nutrition-icon">ğŸ”¬</text>
        <text>è¥å…»åˆ†æ</text>
      </view>
      <view wx:if="{{!nutritionData && !analyzingNutrition}}" class="analyze-btn" bindtap="analyzeNutrition">
        <text class="analyze-icon">âœ¨</text>
        <text>å¼€å§‹åˆ†æ</text>
      </view>
    </view>
    
    <!-- åˆ†æä¸­ -->
    <view wx:if="{{analyzingNutrition}}" class="analyzing">
      <view class="loading-spinner"></view>
      <text class="analyzing-text">AIæ­£åœ¨åˆ†æé£Ÿç‰©è¥å…»æˆåˆ†...</text>
    </view>
    
    <!-- åˆ†æç»“æœ -->
    <view wx:if="{{nutritionData && !analyzingNutrition}}" class="nutrition-result slide-up">
      <!-- è¯†åˆ«çš„é£Ÿç‰© -->
      <view class="foods-detected">
        <text class="result-subtitle">è¯†åˆ«åˆ°çš„é£Ÿç‰©</text>
        <view class="food-tags">
          <view wx:for="{{nutritionData.foods}}" wx:key="name" class="food-tag">
            <text class="food-name">{{item.name}}</text>
            <text class="food-portion">{{item.portion}}{{item.unit}}</text>
            <text class="food-confidence">{{item.confidence}}%</text>
          </view>
        </view>
      </view>
      
      <!-- è¥å…»æˆåˆ† -->
      <view class="nutrition-stats">
        <text class="result-subtitle">è¥å…»æˆåˆ†æ€»è®¡</text>
        <view class="nutrition-grid">
          <view class="nutrition-item">
            <text class="nutrition-value">{{nutritionData.totalNutrition.calories}}</text>
            <text class="nutrition-label">å¡è·¯é‡Œ</text>
            <text class="nutrition-unit">kcal</text>
          </view>
          <view class="nutrition-item">
            <text class="nutrition-value">{{nutritionData.totalNutrition.protein}}</text>
            <text class="nutrition-label">è›‹ç™½è´¨</text>
            <text class="nutrition-unit">g</text>
          </view>
          <view class="nutrition-item">
            <text class="nutrition-value">{{nutritionData.totalNutrition.fat}}</text>
            <text class="nutrition-label">è„‚è‚ª</text>
            <text class="nutrition-unit">g</text>
          </view>
          <view class="nutrition-item">
            <text class="nutrition-value">{{nutritionData.totalNutrition.carbs}}</text>
            <text class="nutrition-label">ç¢³æ°´</text>
            <text class="nutrition-unit">g</text>
          </view>
          <view class="nutrition-item">
            <text class="nutrition-value">{{nutritionData.totalNutrition.fiber}}</text>
            <text class="nutrition-label">çº¤ç»´</text>
            <text class="nutrition-unit">g</text>
          </view>
        </view>
      </view>
      
      <!-- å¥åº·å»ºè®® -->
      <view wx:if="{{nutritionData.suggestions.length > 0}}" class="health-suggestions">
        <text class="result-subtitle">å¥åº·å»ºè®®</text>
        <view class="suggestion-list">
          <view wx:for="{{nutritionData.suggestions}}" wx:key="index" 
                class="suggestion-item {{item.type}}">
            <text class="suggestion-icon">{{item.type === 'success' ? 'âœ…' : item.type === 'warning' ? 'âš ï¸' : 'â„¹ï¸'}}</text>
            <text class="suggestion-text">{{item.text}}</text>
          </view>
        </view>
      </view>
      
      <!-- é‡æ–°åˆ†ææŒ‰é’® -->
      <view class="reanalyze-btn" bindtap="analyzeNutrition">
        <text>é‡æ–°åˆ†æ</text>
      </view>
    </view>
  </view>

  <!-- é¤æ¬¡é€‰æ‹© -->
  <view class="meal-section card">
    <view class="section-title">é€‰æ‹©é¤æ¬¡</view>
    <view class="meal-options">
      <view wx:for="{{mealTypes}}" wx:key="value" 
            class="meal-option {{mealType === item.value ? 'active' : ''}}"
            bindtap="selectMealType" data-value="{{item.value}}">
        <text class="meal-icon">{{item.icon}}</text>
        <text class="meal-label">{{item.label}}</text>
      </view>
    </view>
  </view>

  <!-- æ ‡ç­¾é€‰æ‹© -->
  <view class="tag-section card">
    <view class="section-title">æ·»åŠ æ ‡ç­¾</view>
    <view class="tag-list">
      <view wx:for="{{tags}}" wx:key="value" 
            class="tag {{item.selected ? 'active' : ''}}"
            bindtap="toggleTag" data-index="{{index}}">
        {{item.value}}
      </view>
    </view>
  </view>

  <!-- æ»¡æ„åº¦è¯„åˆ† -->
  <view class="satisfaction-section card">
    <view class="section-title">æ»¡æ„åº¦</view>
    <view class="satisfaction-options">
      <view class="satisfaction-option {{satisfaction === 1 ? 'active' : ''}}" 
            bindtap="selectSatisfaction" data-value="{{1}}">
        <text>ğŸ˜</text>
        <text class="satisfaction-label">ä¸æ»¡æ„</text>
      </view>
      <view class="satisfaction-option {{satisfaction === 3 ? 'active' : ''}}" 
            bindtap="selectSatisfaction" data-value="{{3}}">
        <text>ğŸ˜</text>
        <text class="satisfaction-label">ä¸€èˆ¬</text>
      </view>
      <view class="satisfaction-option {{satisfaction === 5 ? 'active' : ''}}" 
            bindtap="selectSatisfaction" data-value="{{5}}">
        <text>ğŸ˜Š</text>
        <text class="satisfaction-label">å¾ˆæ»¡æ„</text>
      </view>
    </view>
  </view>

  <!-- çƒ­é‡ç­‰çº§ -->
  <view class="calorie-section card">
    <view class="section-title">çƒ­é‡ç­‰çº§</view>
    <view class="calorie-options">
      <view wx:for="{{calorieLevels}}" wx:key="value"
            class="calorie-option {{calorieLevel === item.value ? 'active' : ''}}"
            style="border-color: {{calorieLevel === item.value ? item.color : '#e5e5e5'}}; color: {{calorieLevel === item.value ? item.color : '#666'}};"
            bindtap="selectCalorieLevel" data-value="{{item.value}}">
        {{item.label}}
      </view>
    </view>
  </view>

  <!-- å¤‡æ³¨ä¿¡æ¯ -->
  <view class="info-section card">
    <view class="info-item">
      <view class="info-label">å¤‡æ³¨</view>
      <textarea class="info-input textarea" 
                placeholder="è®°å½•ä¸€ä¸‹æ„Ÿå—..." 
                bindinput="inputDescription"
                value="{{description}}"
                maxlength="200"></textarea>
    </view>
    <view class="info-item" bindtap="getLocation">
      <view class="info-label">åœ°ç‚¹</view>
      <view class="info-value">
        <text wx:if="{{location}}">{{location}}</text>
        <text wx:else class="placeholder">ç‚¹å‡»é€‰æ‹©åœ°ç‚¹</text>
        <text class="arrow-icon">â€º</text>
      </view>
    </view>
  </view>

  <!-- ä¿å­˜æŒ‰é’® -->
  <view class="save-section">
    <button class="save-btn" bindtap="saveRecord" disabled="{{uploading}}">
      {{uploading ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜è®°å½•'}}
    </button>
  </view>
</view>